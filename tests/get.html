<!DOCTYPE html>
<html lang="en" class="p-0 m-0">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover, user-scalable=no, minimal-ui, maximum-scale=1.0, minimum-scale=1.0" />
    <title>Get test</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,container-queries"></script>
  </head>
  <body
    class="bg-gray-100 text-gray-900 font-sans text-[21px] flex flex-col items-stretch justify-center min-h-dvh gap-[21px]">
    <div
      class="flex flex-col items-stretch justify-start gap-[21px] p-[21px] mx-auto md:w-[768px] bg-white rounded-xl shadow-xl border-gray-300">
      <h1 class="text-lg">Test fab-analytics api get</h1>
    </div>

    <div
      id="results-wrapper"
      class="flex flex-col items-stretch justify-start gap-[21px] p-[21px] mx-auto md:w-[1170px] bg-white rounded-xl shadow-xl border-gray-300">
      <h1 class="text-lg">Dashboard</h1>
      <div class="flex flex-row items-stretch justify-start">
        <div class="grow">
          <h2>Totals</h2>
        </div>
        <div>
          <input type="date" class="date-picker" name="start" />
          <input type="date" class="date-picker" name="end" />
        </div>
      </div>

      <div class="totals grid grid-cols-6 gap-[21px] text-center">
        <div class="domains-total flex flex-col items-stretch justify-center">
          <div
            class="count totals-count total-domains text-4xl font-black grow">
            0
          </div>
          <div class="font-thin">Domains</div>
        </div>

        <div class="pageviews-total flex flex-col items-stretch justify-center">
          <div
            class="count totals-count total-pageviews text-4xl font-black grow">
            0
          </div>
          <div class="font-thin">Pageviews</div>
        </div>

        <div class="sessions-total flex flex-col items-stretch justify-center">
          <div
            class="count totals-count total-sessions text-4xl font-black grow">
            0
          </div>
          <div class="font-thin">Sessions</div>
        </div>

        <div class="visitors-total flex flex-col items-stretch justify-center">
          <div
            class="count totals-count total-visitors text-4xl font-black grow">
            0
          </div>
          <div class="font-thin">Visitors</div>
        </div>

        <div
          class="conversions-total flex flex-col items-stretch justify-center">
          <div
            class="count totals-count total-conversions text-4xl font-black grow">
            0
          </div>
          <div class="font-thin">Conversions</div>
        </div>

        <div
          class="flex flex-col items-stretch justify-center gap-[21px] text-left">
          <div class="calls-total flex flex-row items-stretch justify-center">
            <div class="grow font-thin">Calls</div>
            <div
              class="count totals-count total-calls text-2xl font-black text-right">
              0
            </div>
          </div>

          <div class="emails-total flex flex-row items-stretch justify-center">
            <div class="grow font-thin">Emails</div>
            <div
              class="count totals-count total-emails text-2xl font-black text-right">
              0
            </div>
          </div>

          <div
            class="submissions-total flex flex-row items-stretch justify-center">
            <div class="grow font-thin">Submissions</div>
            <div
              class="count totals-count total-submissions text-2xl font-black text-right">
              0
            </div>
          </div>
        </div>
      </div>
      <div id="results"></div>
    </div>

    <template id="result-template">
      <div class="result-item">
        <div class="accordion-title flex flex-row items-center justify-between">
          <div class="grow">
            <h2 class="domain text-4xl">{{domain_name}}</h2>
          </div>
          <div>
            <img src="view.svg" />
          </div>
        </div>
        <div class="result-item-data">
          <div
            class="data-summary grid grid-cols-5 gap-[21px] text-center w-full">
            <div
              class="summary-item pageviews p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{pageviews}}</span>
              </div>
              <div>page views</div>
            </div>
            <div
              class="summary-item unique-sessions p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{unique_sessions}}</span>
              </div>
              <div>sessions</div>
            </div>
            <div
              class="summary-item unique-visitors p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{unique_visitors}}</span>
              </div>
              <div>visitors</div>
            </div>
            <div
              class="summary-item conversions p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{conversions}}</span>
              </div>
              <div>conversions</div>
            </div>
            <div
              class="summary-stack flex flex-col items-stretch justify-start gap-[21px] text-left">
              <div
                class="summary-item calls shadow-xl rounded-xl p-[11px] flex flex-row items-center justofy-start">
                <div class="grow">calls</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{calls}}
                </div>
              </div>
              <div
                class="summary-item emails shadow-xl rounded-xl p-[11px] flex flex-row items-center justofy-start">
                <div class="grow">emails</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{emails}}
                </div>
              </div>
              <div
                class="summary-item submissions shadow-xl rounded-xl p-[11px] flex flex-row items-center justofy-start">
                <div class="grow">submissions</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{submissions}}
                </div>
              </div>
              <div
                class="summary-item conversion-rate shadow-xl rounded-xl p-[11px] flex flex-row items-center justofy-start">
                <div class="grow">conversion rate</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{conversion_rate}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template id="leads-template">
      <div class="data-leads">
        <div class="accordion-title">
          <div>
            <h3>Leads</h3>
          </div>
          <div>
            <img src="view.svg" />
          </div>
        </div>

        <div class="data-leads-table">
          <table class="w-full">
            <thead class="text-left">
              <tr></tr>
            </thead>

            <tbody></tbody>
          </table>
        </div>
      </div>
    </template>

    <template id="lead-actions-template">
      <td>
        <div class="lead-actions">
          <button class="lead-action view"><img src="view.svg" /></button>
          <button class="lead-action reply"><img src="reply.svg" /></button>
          <button class="lead-action fwd"><img src="fwd.svg" /></button>
          <button class="lead-action archive"><img src="archive.svg" /></button>
          <button class="lead-action flag"><img src="flag.svg" /></button>
          <button class="lead-action delete"><img src="delete.svg" /></button>
        </div>
      </td>
    </template>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch(`https://www.hustlelaunch.com/fab-analytics/api/get/`)
          .then((response) => response.json())
          .then((data) => createDashboard(data));
      });

      function createDashboard(data) {
        const results = document.getElementById("results");
        results.innerHTML = ""; // Clear any previous content
        const template = document.getElementById("result-template").content;
        const totals = document.querySelector(".totals");

        let $total_domains = totals.querySelector(".domains-total .count"),
          $total_pageviews = totals.querySelector(".pageviews-total .count"),
          $total_sessions = totals.querySelector(".sessions-total .count"),
          $total_visitors = totals.querySelector(".visitors-total .count"),
          $total_conversions = totals.querySelector(
            ".conversions-total .count"
          ),
          $total_calls = totals.querySelector(".calls-total .count"),
          $total_emails = totals.querySelector(".emails-total .count"),
          $total_submissions = totals.querySelector(
            ".submissions-total .count"
          );

        $total_domains.textContent = Object.keys(data).length;

        const domainsArray = Object.values(data);

        $total_pageviews.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.pageviews,
          0
        );

        $total_sessions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.unique_sessions,
          0
        );

        $total_visitors.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.unique_visitors,
          0
        );

        $total_conversions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.conversions,
          0
        );

        $total_calls.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.calls,
          0
        );

        $total_emails.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.emails,
          0
        );

        $total_submissions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.submissions,
          0
        );

        for (const domain in data) {
          const clone = document.importNode(template, true);
          const domainData = data[domain];

          const conversionRate = (
            (domainData.conversions / domainData.unique_sessions) *
            100
          ).toFixed(2);

          clone.querySelector(".domain").textContent = domain;
          clone.querySelector(".pageviews .summary-count").textContent =
            domainData.pageviews;
          clone.querySelector(".unique-sessions .summary-count").textContent =
            domainData.unique_sessions;
          clone.querySelector(".unique-visitors .summary-count").textContent =
            domainData.unique_visitors;
          clone.querySelector(".conversions .summary-count").textContent =
            domainData.conversions;
          clone.querySelector(".calls .summary-count").textContent =
            domainData.calls;
          clone.querySelector(".emails .summary-count").textContent =
            domainData.emails;
          clone.querySelector(".submissions .summary-count").textContent =
            domainData.submissions;
          clone.querySelector(".conversion-rate .summary-count").textContent =
            conversionRate + "%";

          if (
            (domain.includes("oxstu") || domain.includes("alay.co")) &&
            domainData.hasOwnProperty("forms") &&
            domainData.forms.length > 0
          ) {
            const leads_template =
              document.getElementById("leads-template").content;
            const data_leads = document.importNode(leads_template, true);
            clone.querySelector(".result-item-data").appendChild(data_leads);

            const table = clone.querySelector("table");
            const thead = table.querySelector("thead");
            const tbody = table.querySelector("tbody");

            // Clear existing header and body
            thead.innerHTML = "";
            tbody.innerHTML = "";

            const form_events = domainData.forms;

            const acceptable_field_keys = [
              /form_fields\[.*\]/,
              /(name|email|phone|message|pass|date|time)/,
            ];

            // Collect all unique column names, excluding 'actions'
            const allColumns = new Set(["time", "page"]);

            form_events.forEach((form_event_data) => {
              const acceptableFields = Object.keys(
                form_event_data.fields
              ).filter((key) =>
                acceptable_field_keys.some((regex) => regex.test(key))
              );

              // Check if the form_event_data contains at least one acceptable field key with a non-empty value
              const rowHasAtLeastOneAcceptableKey = () => {
                let pass = false;

                const foundKeys = Object.keys(form_event_data.fields).filter(
                  (key) =>
                    acceptable_field_keys.some((regex) => regex.test(key))
                );

                // At least one key has a value
                if (foundKeys.length > 0) {
                  foundKeys.forEach((key) => {
                    if (form_event_data.fields[key] !== "") {
                      pass = true;
                    }
                  });

                  pass = pass || false;
                }

                return pass;
              };

              if (!rowHasAtLeastOneAcceptableKey()) {
                return; // Skip this row
              }

              const hasNonEmptyAcceptableField = acceptableFields.some(
                (key) => form_event_data.fields[key] !== ""
              );

              if (hasNonEmptyAcceptableField) {
                acceptableFields.forEach((key) => {
                  if (form_event_data.fields[key] !== "") {
                    const field_name = key
                      .replace("form_fields[", "")
                      .replace("]", "");
                    allColumns.add(field_name);
                  }
                });
              }

              // Convert Set to Array and add 'actions' at the end
              const columnArray = Array.from(allColumns);
              columnArray.push("actions");

              // Create header row
              const headerRow = document.createElement("tr");
              allColumns.forEach((column) => {
                const th = document.createElement("th");
                th.textContent = column;
                th.className = column;
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);

              // Create data rows
              form_events.forEach((form_event_data) => {
                const row = document.createElement("tr");
                row.dataset.time = form_event_data.time;
                row.dataset.status = form_event_data.status;
                row.classList.add(
                  form_event_data.status == "conversion"
                    ? "bg-green-100"
                    : "bg-red-100"
                );

                allColumns.forEach((column) => {
                  const td = document.createElement("td");
                  td.className = column;

                  switch (column) {
                    case "time":
                      td.textContent = form_event_data.time
                        ? new Date(form_event_data.time).toLocaleString()
                        : "";
                      break;
                    case "page":
                      td.textContent = form_event_data.page || "";
                      break;
                    case "actions":
                      td.innerHTML = `
              <div class="lead-actions">
                <button class="lead-action view"><img src="view.svg" /></button>
                <button class="lead-action reply"><img src="reply.svg" /></button>
                <button class="lead-action fwd"><img src="fwd.svg" /></button>
                <button class="lead-action archive"><img src="archive.svg" /></button>
                <button class="lead-action flag"><img src="flag.svg" /></button>
                <button class="lead-action delete"><img src="delete.svg" /></button>
              </div>`;
                      break;
                    default:
                      const fieldKey = `form_fields[${column}]`;
                      td.textContent =
                        form_event_data.fields[fieldKey] ||
                        form_event_data.fields[column] ||
                        "";
                  }

                  row.appendChild(td);
                });

                tbody.appendChild(row);
              });
            });
          }

          results.appendChild(clone);
        }
      }
    </script>
  </body>
</html>
