<!DOCTYPE html>
<html lang="en" class="p-0 m-0">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover, user-scalable=no, minimal-ui, maximum-scale=1.0, minimum-scale=1.0" />
    <title>Get test</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body
    class="bg-gray-100 text-gray-900 font-sans text-[21px] flex flex-col items-stretch justify-center min-h-dvh gap-[21px]">
    <div
      id="results-wrapper"
      class="flex flex-col items-stretch justify-start gap-[21px] mx-auto md:max-w-[1170px] px-[21px] py-[42px]">
      <h1 class="text-4xl font-black">dashboard</h1>
      <div
        class="flex flex-col items-stretch justify-start gap-[21px] w-full bg-white rounded-xl shadow-xl border border-gray-300 border-solid">
        <div
          class="flex flex-row items-center justify-start p-[21px] gap-[21px]">
          <div class="">
            <h2>totals</h2>
          </div>
          <div
            class="filters flex items-start justify-start grow min-w-min md:w-50 max-w-full">
            <input
              type="search"
              class="search-filter rounded-l-full text-md placeholder:text-md px-[21px] py-[11px] border border-gray-300 border-solid block"
              id="domain-filter"
              name="domain-filter"
              placeholder="domain"
              list="domain-list" />
            <datalist id="domain-list"></datalist>
            <ul class="dropdown-menu list-none block grow">
              <li class="relative hover:*:scale-y-100 group">
                <a
                  href="#toggle-menu"
                  class="menu-toggle down-caret border border-gray-300 border-solid rounded-r-full bg-white flex items-center justify-between px-[21px] py-[11px] relative z-20"
                  ><span class="date-range-label text-md text-gray-400 block"
                    >date range</span
                  >
                  <span
                    class="date-range-value bg-blue-500 rounded-full text-white block px-[21px] py-[11px] text-sm absolute right-[11px]"
                    >All</span
                  ></a
                >
                <ul
                  id="menu"
                  class="dropdown-menu-items list-none min-w-min w-full bg-white rounded-xl shadow-xl flex flex-col items-stretch justify-start divide-y divide-gray-300 *:*:text-sm absolute top-[14px] pt-[42px] border border-gray-300 border-solid scale-y-0 duration-300 ease-in-out origin-top group-hover:scale-y-100">
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="all"
                        checked />
                      <span>All</span></label
                    >
                  </li>
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="last-7-days" />
                      <span>Last 7 Days</span></label
                    >
                  </li>
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="last-30-days" />
                      <span>Last 30 Days</span></label
                    >
                  </li>
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="last-quarter" />
                      <span>Last quarter</span></label
                    >
                  </li>
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="year-to-date" />
                      <span>Year To Date</span></label
                    >
                  </li>
                  <li>
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="last-12-months" />
                      <span>Last 12 Months</span></label
                    >
                  </li>
                  <li class="group">
                    <label
                      class="p-[11px] bg-white hover:bg-gray-100 has-[input:checked]:bg-blue-500 has-[input:checked]:text-white block cursor-pointer peer"
                      ><input
                        class="hidden"
                        type="radio"
                        name="date-range"
                        value="custom" />
                      <span>Custom</span></label
                    >
                    <div
                      class="flex flex-row items-center justify-start p-[11px]">
                      <label
                        class="flex items-center gap-[11px] grow w-50 px-[21px] py-[11px] border border-solid border-gray-300 rounded-l-full"
                        ><span>start</span>
                        <input
                          type="date"
                          class="date-picker text-md p-0 grow group-has-[label input:not(::checked)]:hidden group-has-[label input:checked]:block outline-none focus:outline-none active:outline-none invalid:outline-none valid:outline-none"
                          name="start" />
                      </label>
                      <label
                        class="flex items-center gap-[11px] grow w-50 px-[21px] py-[11px] border border-solid border-gray-300 rounded-r-full"
                        ><span>end</span>
                        <input
                          type="date"
                          class="date-picker text-md p-0 grow group-has-[label input:not(::checked)]:hidden group-has-[label input:checked]:block outline-none focus:outline-none active:outline-none invalid:outline-none valid:outline-none"
                          name="start" />
                      </label>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>

        <div
          class="totals grid grid-cols-6 gap-[21px] text-center p-[21px] bg-gray-100 rounded-xl rounded-t-none">
          <div
            class="domains-total flex flex-col items-stretch justify-center rounded-xl shadow-lg border-gray-300 border-1 border-solid bg-white">
            <div
              class="count totals-count total-domains text-4xl font-black grow flex items-center justify-center p-[21px]">
              <span>0</span>
            </div>
            <div class="font-thin p-[11px]">Domains</div>
          </div>

          <div
            class="pageviews-total flex flex-col items-stretch justify-center rounded-xl shadow-lg border-gray-300 border-1 border-solid bg-white">
            <div
              class="count totals-count total-pageviews text-4xl font-black grow flex items-center justify-center p-[21px]">
              <span>0</span>
            </div>
            <div class="font-thin p-[11px]">Pageviews</div>
          </div>

          <div
            class="sessions-total flex flex-col items-stretch justify-center rounded-xl shadow-lg border-gray-300 border-1 border-solid bg-white">
            <div
              class="count totals-count total-sessions text-4xl font-black grow flex items-center justify-center p-[21px]">
              <span>0</span>
            </div>
            <div class="font-thin p-[11px]">Sessions</div>
          </div>

          <div
            class="visitors-total flex flex-col items-stretch justify-center rounded-xl shadow-lg border-gray-300 border-1 border-solid bg-white">
            <div
              class="count totals-count total-visitors text-4xl font-black grow flex items-center justify-center p-[21px]">
              <span>0</span>
            </div>
            <div class="font-thin p-[11px]">Visitors</div>
          </div>

          <div
            class="conversions-total flex flex-col items-stretch justify-center rounded-xl shadow-lg border-gray-300 border-1 border-solid bg-white">
            <div
              class="count totals-count total-conversions text-4xl font-black grow flex items-center justify-center p-[21px]">
              <span>0</span>
            </div>
            <div class="font-thin p-[11px]">Conversions</div>
          </div>

          <div
            class="flex flex-col items-stretch justify-center gap-[21px] text-left divide-y-1 divide-y-gray-300">
            <div class="calls-total flex flex-row items-stretch justify-center">
              <div class="grow font-thin">Calls</div>
              <div
                class="count totals-count total-calls text-2xl font-black text-right">
                0
              </div>
            </div>

            <div
              class="emails-total flex flex-row items-stretch justify-center">
              <div class="grow font-thin">Emails</div>
              <div
                class="count totals-count total-emails text-2xl font-black text-right">
                0
              </div>
            </div>

            <div
              class="submissions-total flex flex-row items-stretch justify-center">
              <div class="grow font-thin">Submissions</div>
              <div
                class="count totals-count total-submissions text-2xl font-black text-right">
                0
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        id="results"
        class="flex flex-col items-stretch justify-start gap-[21px] w-full"></div>
    </div>

    <template id="result-template">
      <div class="result-item bg-white rounded-xl shadow-xl border-gray-300">
        <div
          class="accordion-title flex flex-row items-center justify-between p-[21px]">
          <div class="grow">
            <h2 class="domain text-4xl">{{domain_name}}</h2>
          </div>
          <div>
            <img src="../icons/view.svg" width="28" height="28" alt="toggle" />
          </div>
        </div>
        <div
          class="result-item-data p-[21px] bg-gray-100 rounded-xl rounded-t-none">
          <div
            class="data-summary grid grid-cols-5 gap-[21px] text-center w-full">
            <div
              class="summary-item pageviews p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start bg-white">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{pageviews}}</span>
              </div>
              <div>page views</div>
            </div>
            <div
              class="summary-item unique-sessions p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start bg-white">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{unique_sessions}}</span>
              </div>
              <div>sessions</div>
            </div>
            <div
              class="summary-item unique-visitors p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start bg-white">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{unique_visitors}}</span>
              </div>
              <div>visitors</div>
            </div>
            <div
              class="summary-item conversions p-[21px] border-1 border-gray-300 rounded-xl shadow-lg flex flex-col items-stretch justify-start bg-white">
              <div
                class="font-black text-4xl grow summary-count flex items-center justify-center">
                <span>{{conversions}}</span>
              </div>
              <div>conversions</div>
            </div>
            <div
              class="summary-stack flex flex-col items-stretch justify-start gap-[21px] text-left">
              <div
                class="summary-item calls flex flex-row items-center justofy-start">
                <div class="grow">calls</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{calls}}
                </div>
              </div>
              <div
                class="summary-item emails flex flex-row items-center justofy-start">
                <div class="grow">emails</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{emails}}
                </div>
              </div>
              <div
                class="summary-item submissions flex flex-row items-center justofy-start">
                <div class="grow">submissions</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{submissions}}
                </div>
              </div>
              <div
                class="summary-item conversion-rate flex flex-row items-center justofy-start">
                <div class="grow">rate</div>
                <div class="font-black text-3xl text-right summary-count">
                  {{conversion_rate}}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          class="charts grid grid-cols-1 grid-rows-1 place-items-center place-content-center">
          <canvas class="chart pageviews-chart"></canvas>
          <canvas class="chart sessions-chart"></canvas>
          <canvas class="chart visitors-chart"></canvas>
          <canvas class="chart conversions-chart"></canvas>
        </div>
      </div>
    </template>

    <template id="leads-template">
      <div
        class="data-leads mt-[42px] bg-white rounded-xl border border-solid border-gray-300 overflow-clip">
        <div
          class="accordion-title flex flex-row items-center justify-between p-[21px]">
          <div class="grow">
            <h3 class="domain text-2xl font-black">Leads</h3>
          </div>
          <div>
            <img src="../icons/view.svg" width="28" height="28" alt="toggle" />
          </div>
        </div>

        <div class="data-leads-table w-full overflow-x-auto">
          <table class="w-full" cellpadding="11">
            <thead class="text-left">
              <tr></tr>
            </thead>

            <tbody></tbody>
          </table>
        </div>
      </div>
    </template>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch(`https://www.hustlelaunch.com/fab-analytics/api/get/`)
          .then((response) => response.json())
          .then((data) => createDashboard(data));
      });

      function createDashboard(data) {
        const results = document.getElementById("results");
        results.innerHTML = ""; // Clear any previous content
        const template = document.getElementById("result-template").content;
        const totals = document.querySelector(".totals");

        let $total_domains = totals.querySelector(".domains-total .count"),
          $total_pageviews = totals.querySelector(".pageviews-total .count"),
          $total_sessions = totals.querySelector(".sessions-total .count"),
          $total_visitors = totals.querySelector(".visitors-total .count"),
          $total_conversions = totals.querySelector(
            ".conversions-total .count"
          ),
          $total_calls = totals.querySelector(".calls-total .count"),
          $total_emails = totals.querySelector(".emails-total .count"),
          $total_submissions = totals.querySelector(
            ".submissions-total .count"
          );

        const domainNames = Object.keys(data);

        $total_domains.textContent = domainNames.length;

        const domainsArray = Object.values(data);

        $total_pageviews.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.pageviews,
          0
        );

        $total_sessions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.unique_sessions,
          0
        );

        $total_visitors.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.unique_visitors,
          0
        );

        $total_conversions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.conversions,
          0
        );

        $total_calls.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.calls,
          0
        );

        $total_emails.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.emails,
          0
        );

        $total_submissions.textContent = domainsArray.reduce(
          (acc, domain) => acc + domain.submissions,
          0
        );

        for (const domain in data) {
          const clone = document.importNode(template, true);
          const domainData = data[domain];
          const item = clone.querySelector(".result-item");

          const conversionRate = (
            (domainData.conversions / domainData.unique_sessions) *
            100
          ).toFixed(2);

          clone.querySelector(".domain").textContent = domain;
          clone.querySelector(".pageviews .summary-count").textContent =
            domainData.pageviews;
          clone.querySelector(".unique-sessions .summary-count").textContent =
            domainData.unique_sessions;
          clone.querySelector(".unique-visitors .summary-count").textContent =
            domainData.unique_visitors;
          clone.querySelector(".conversions .summary-count").textContent =
            domainData.conversions;
          clone.querySelector(".calls .summary-count").textContent =
            domainData.calls;
          clone.querySelector(".emails .summary-count").textContent =
            domainData.emails;
          clone.querySelector(".submissions .summary-count").textContent =
            domainData.submissions;
          clone.querySelector(".conversion-rate .summary-count").textContent =
            conversionRate + "%";

          const domainAllEvents = domainData.data; // this is an object with keys session_start, session_end, pathname, ip, viewport, user_agent, referrer, browser_language, browser_timezone, device, screen, title, event, category, action, data

          console.log(domainAllEvents);

          const getMetricByDateUnique = (metric) => {
            const uniqueDates = new Set(); // something is missing here?
            const metricByDate = {};
            const data = chartData[metric];

            for (const event of chartData[metric]) {
              if (event.event === metric) {
                const date = new Date(event.session_start);
                const dateString = date.toLocaleDateString("en-US", {
                  month: "2-digit",
                  day: "2-digit",
                  year: "numeric",
                });

                if (!uniqueDates.has(dateString)) {
                  uniqueDates.add(dateString);
                  metricByDate[dateString] = 0;
                }

                metricByDate[dateString] += 1;
              }
            }

            return metricByDate;
          };

          const renderChart = (ctx, metric, title) => {
            const data = getMetricByDateUnique(metric);

            const chart = new Chart(ctx, {
              type: "line",
              data: {
                labels: Object.keys(data), // needs to return an array of unique dates (mm/dd/yyy)
                datasets: [
                  {
                    label: title,
                    data: Object.values(data).map((events) => events.length),
                    borderColor: "rgb(59, 130, 246)",
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    fill: true,
                  },
                ],
              },
            });

            // set the canvas width and height to parent div width and 400px
            ctx.width = item.querySelector(".charts").clientWidth;
            ctx.height = 400;
          };

          if (
            domainData.hasOwnProperty("forms") &&
            domainData.forms.length > 0
          ) {
            const leads_template =
              document.getElementById("leads-template").content;
            const data_leads = document.importNode(leads_template, true);
            clone.querySelector(".result-item-data").appendChild(data_leads);

            const table = clone.querySelector("table");
            const thead = table.querySelector("thead");
            const tbody = table.querySelector("tbody");

            // Clear existing header and body
            thead.innerHTML = "";
            tbody.innerHTML = "";

            const form_events = domainData.forms;
            const ele_pattern = /form_fields\[(.*)\]/;
            const acf_pattern = /acf\[(.*)\]/;

            const acceptable_field_keys = [
              ele_pattern,
              acf_pattern,
              /(name|email|phone|message|pass|date|time)/,
            ];

            const known_acf_labels = {
              field_6613c21fa5dd0: "to",
              "field_6613c25da5dd1][field_65fae707f6a6c": "first",
              "field_6613c25da5dd1][field_65faf9a0f6a6d": "last",
              "field_6613c25da5dd1][field_65faf9b3f6a6e": "phone",
              "field_6613c25da5dd1][field_65faf9baf6a6f": "email",
              "field_6613c25da5dd1][field_65faf9c4f6a70": "b|s",
              "field_6613c25da5dd1][field_65fafa0bf6a71": "type",
              "field_6613c25da5dd1][field_66731663a7b86": "lease",
              "field_6613c25da5dd1][field_65fb04c8b57a4": "range",
              "field_6613c25da5dd1][field_65fb0568df3cb": "location",
              "field_6613c25da5dd1][field_65fb057b24704": "funding",
              "field_6613c25da5dd1][field_65fb05bc92209": "value",
              "field_6613c25da5dd1][field_65fb05c39220a": "address",
            };

            // Collect all unique column names, excluding 'actions'
            const allColumns = new Set(["time", "page"]);

            form_events.forEach((form_event_data) => {
              Object.keys(form_event_data.fields).forEach((key) => {
                if (
                  acceptable_field_keys.some((regex) => regex.test(key)) &&
                  form_event_data.fields[key] !== ""
                ) {
                  let field_name = key
                    .replace(ele_pattern, "$1")
                    .replace(acf_pattern, "$1");

                  // Add to the set
                  allColumns.add(field_name);
                }
              });
            });

            // Convert Set to Array and add 'actions' at the end
            const columnArray = Array.from(allColumns);
            columnArray.push("actions");

            // Create header row
            const headerRow = document.createElement("tr");
            columnArray.forEach((column) => {
              const th = document.createElement("th");
              th.textContent = known_acf_labels[column] || column;
              th.className = column;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create data rows
            form_events.forEach((form_event_data) => {
              const rowHasAtLeastOneAcceptableKey = () => {
                let pass = false;

                const foundKeys = Object.keys(form_event_data.fields).filter(
                  (key) =>
                    acceptable_field_keys.some((regex) => regex.test(key))
                );

                // at least one key has a value
                if (foundKeys.length > 0) {
                  foundKeys.forEach((key) => {
                    if (form_event_data.fields[key] !== "") {
                      pass = true;
                    }
                  });

                  pass = pass || false;
                }

                return pass;
              };

              if (!rowHasAtLeastOneAcceptableKey()) {
                return;
              }

              const row = document.createElement("tr");

              row.dataset.time = form_event_data.time;
              row.dataset.status = form_event_data.status;

              const statusClass =
                form_event_data.status == "conversion"
                  ? [
                      "bg-green-100",
                      "odd:bg-green-100/50",
                      "hover:bg-green-200",
                      "odd:hover:bg-green-200/50",
                    ]
                  : [
                      "bg-red-100",
                      "odd:bg-red-100/50",
                      "hover:bg-red-200",
                      "odd:hover:bg-red-200/50",
                    ];

              row.classList.add(...statusClass);

              columnArray.forEach((column) => {
                const td = document.createElement("td");

                td.className = column;

                switch (column) {
                  case "time":
                    td.textContent = form_event_data.time
                      ? new Date(
                          parseInt(form_event_data.time * 1000)
                        ).toLocaleString()
                      : "";

                    break;
                  case "page":
                    td.textContent = form_event_data.page || "";

                    break;
                  case "actions":
                    td.innerHTML = `
                <div class="lead-actions grid grid-cols-6">
                  <button class="lead-action view"><img src="../icons/view.svg" width="28" hieght="28" /></button>
                  <button class="lead-action reply"><img src="../icons/reply.svg" width="28" hieght="28" /></button>
                  <button class="lead-action fwd"><img src="../icons/fwd.svg" width="28" hieght="28" /></button>
                  <button class="lead-action archive"><img src="../icons/archive.svg" width="28" hieght="28" /></button>
                  <button class="lead-action flag"><img src="../icons/flag.svg" width="28" hieght="28" /></button>
                  <button class="lead-action delete"><img src="../icons/trash.svg" width="28" hieght="28" /></button>
                </div>`;

                    break;
                  default:
                    const fieldKey = `form_fields[${column}]`;
                    td.textContent =
                      form_event_data.fields[fieldKey] ||
                      form_event_data.fields[column] ||
                      "";
                }

                row.appendChild(td);
              });

              tbody.appendChild(row);
            });
          }

          item.dataset.domain = domain; // TypeError: Cannot set properties of undefined (setting 'domain')
          results.appendChild(clone);

          /* render the charts
          renderChart(
            item.querySelector(".pageviews-chart"),
            "pageviews",
            "Pageviews"
          ); */
        }

        const domainList = document.querySelector("#domain-list");
        domainNames.forEach((domainName) => {
          const option = document.createElement("option");
          option.value = domainName;
          option.textContent = domainName;
          domainList.appendChild(option);
        });

        const domainFilter = document.querySelector("#domain-filter");

        const filterEvents = ["keyup", "change"];
        filterEvents.forEach((eventType) => {
          domainFilter.addEventListener(eventType, (e) => {
            const domainName = e.target.value.toLowerCase(); // Convert to lowercase for case-insensitive matching
            const results = document.querySelectorAll(".result-item");
            results.forEach((result) => {
              // Check if the domainName is part of the data-domain attribute
              if (
                domainName === "" ||
                result.dataset.domain.toLowerCase().includes(domainName)
              ) {
                result.style.display = "block"; // Show the result
              } else {
                result.style.display = "none"; // Hide the result
              }
            });
          });
        });
      }
    </script>
  </body>
</html>
